@page "/orders"
@using SD.Mercato.UI.Client.Services
@inject IOrderService OrderService
@inject NavigationManager Navigation

<PageTitle>My Orders - Mercato</PageTitle>

<div class="container mt-4">
    <h1 class="mb-4">My Orders</h1>

    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (orders == null || !orders.Any())
    {
        <div class="alert alert-info">
            <h4>No orders yet</h4>
            <p>You haven't placed any orders yet. Browse our <a href="/catalog">product catalog</a> to get started.</p>
        </div>
    }
    else
    {
        @foreach (var order in orders)
        {
            <div class="card mb-3">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-0">
                                Order #@order.OrderNumber
                            </h5>
                            <small class="text-muted">Placed on @order.CreatedAt.ToString("MMM dd, yyyy")</small>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <span class="badge bg-@GetStatusBadgeClass(order.Status)">
                                @order.Status
                            </span>
                            <span class="badge bg-@GetPaymentStatusBadgeClass(order.PaymentStatus) ms-2">
                                @order.PaymentStatus
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h6>Delivery Address</h6>
                            <p class="mb-2">
                                @order.DeliveryRecipientName<br />
                                @order.DeliveryAddressLine1<br />
                                @if (!string.IsNullOrEmpty(order.DeliveryAddressLine2))
                                {
                                    @order.DeliveryAddressLine2<br />
                                }
                                @order.DeliveryCity, @order.DeliveryState @order.DeliveryPostalCode<br />
                                @order.DeliveryCountry
                            </p>

                            <h6 class="mt-3">Items from Sellers</h6>
                            @foreach (var subOrder in order.SubOrders)
                            {
                                <div class="border-start border-3 ps-3 mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0">
                                            <i class="bi bi-shop"></i> @subOrder.StoreName
                                        </h6>
                                        <span class="badge bg-@GetSubOrderStatusBadgeClass(subOrder.Status)">
                                            @subOrder.Status
                                        </span>
                                    </div>
                                    
                                    @foreach (var item in subOrder.Items)
                                    {
                                        <div class="d-flex justify-content-between small mb-1">
                                            <span>@item.ProductTitle Ã— @item.Quantity</span>
                                            <span>$@item.Subtotal.ToString("F2")</span>
                                        </div>
                                    }
                                    
                                    <div class="d-flex justify-content-between small text-muted mt-1">
                                        <span>Shipping (@subOrder.ShippingMethod):</span>
                                        <span>$@subOrder.ShippingCost.ToString("F2")</span>
                                    </div>
                                    
                                    @if (!string.IsNullOrEmpty(subOrder.TrackingNumber))
                                    {
                                        <div class="mt-2 small">
                                            <i class="bi bi-box-seam"></i> Tracking: <code>@subOrder.TrackingNumber</code>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                        <div class="col-md-4">
                            <h6>Order Summary</h6>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Total Amount:</span>
                                <strong class="text-primary">$@order.TotalAmount.ToString("F2")</strong>
                            </div>
                            <div class="d-flex justify-content-between small text-muted mb-2">
                                <span>Payment Method:</span>
                                <span>@order.PaymentMethod</span>
                            </div>
                            @if (order.PaidAt.HasValue)
                            {
                                <div class="d-flex justify-content-between small text-muted">
                                    <span>Paid on:</span>
                                    <span>@order.PaidAt.Value.ToString("MMM dd, yyyy")</span>
                                </div>
                            }
                            
                            <div class="mt-3">
                                <button class="btn btn-outline-primary btn-sm w-100" @onclick="@(() => ViewOrderDetails(order.Id))">
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private List<OrderDto>? orders;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        isLoading = true;
        orders = await OrderService.GetOrdersAsync();
        isLoading = false;
    }

    private void ViewOrderDetails(Guid orderId)
    {
        Navigation.NavigateTo($"/orders/{orderId}");
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Pending" => "warning",
            "Processing" => "info",
            "Completed" => "success",
            "Cancelled" => "danger",
            _ => "secondary"
        };
    }

    private string GetPaymentStatusBadgeClass(string status)
    {
        return status switch
        {
            "Pending" => "warning",
            "Paid" => "success",
            "Failed" => "danger",
            "Refunded" => "info",
            _ => "secondary"
        };
    }

    private string GetSubOrderStatusBadgeClass(string status)
    {
        return status switch
        {
            "Pending" => "warning",
            "Processing" => "info",
            "Shipped" => "primary",
            "Delivered" => "success",
            "Cancelled" => "danger",
            _ => "secondary"
        };
    }
}
