@page "/seller/financial-report"
@using SD.Mercato.UI.Client.Services
@inject ISellerReportService ReportService
@inject NavigationManager Navigation
@inject IAuthService AuthService

<PageTitle>Financial Report - Seller Panel - Mercato</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Financial Report</h1>
        <div class="text-muted">
            Seller Panel
        </div>
    </div>

    <!-- Period Selection -->
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title mb-3">Select Reporting Period</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="periodType" class="form-label">Period Type</label>
                    <select id="periodType" class="form-select" @bind="periodType" @bind:after="OnPeriodTypeChanged">
                        <option value="custom">Custom Range</option>
                        <option value="thisMonth">This Month</option>
                        <option value="lastMonth">Last Month</option>
                        <option value="last3Months">Last 3 Months</option>
                        <option value="last6Months">Last 6 Months</option>
                        <option value="thisYear">This Year</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="startDate" class="form-label">Start Date</label>
                    <input type="date" id="startDate" class="form-control" @bind="startDate" disabled="@(periodType != "custom")" />
                </div>
                <div class="col-md-3">
                    <label for="endDate" class="form-label">End Date</label>
                    <input type="date" id="endDate" class="form-control" @bind="endDate" disabled="@(periodType != "custom")" />
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-primary w-100" @onclick="LoadReport">
                        <i class="bi bi-search"></i> Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading financial report...</p>
        </div>
    }
    else if (summary != null)
    {
        <!-- Financial Summary -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Financial Summary</h5>
                <small>@summary.PeriodStartDate.ToString("yyyy-MM-dd") to @summary.PeriodEndDate.ToString("yyyy-MM-dd")</small>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="border rounded p-3 bg-light">
                            <div class="text-muted small">Total GMV</div>
                            <div class="fs-4 fw-bold text-primary">@summary.TotalGMV.ToString("C2")</div>
                            <div class="small text-muted">Products: @summary.TotalProductValue.ToString("C2")</div>
                            <div class="small text-muted">Shipping: @summary.TotalShippingFees.ToString("C2")</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="border rounded p-3 bg-light">
                            <div class="text-muted small">Total Deductions</div>
                            <div class="fs-4 fw-bold text-danger">-@(summary.TotalCommission + summary.TotalProcessingFees).ToString("C2")</div>
                            <div class="small text-muted">Commission: @summary.TotalCommission.ToString("C2")</div>
                            <div class="small text-muted">Processing Fees: @summary.TotalProcessingFees.ToString("C2")</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="border rounded p-3 bg-success bg-opacity-10">
                            <div class="text-muted small">Net Amount Due</div>
                            <div class="fs-4 fw-bold text-success">@summary.NetAmountDue.ToString("C2")</div>
                            <div class="small text-muted">Orders: @summary.OrderCount</div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="mt-4">
                    <button class="btn btn-outline-primary" @onclick="ViewBreakdown">
                        <i class="bi bi-list-ul"></i> View Detailed Breakdown
                    </button>
                    <button class="btn btn-outline-success" @onclick="GenerateInvoice">
                        <i class="bi bi-file-earmark-text"></i> Generate Invoice
                    </button>
                </div>
            </div>
        </div>

        @if (showBreakdown && breakdown != null)
        {
            <!-- Detailed Breakdown -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Commission Breakdown by Line Item</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Order Date</th>
                                    <th>SubOrder #</th>
                                    <th>Product</th>
                                    <th class="text-end">Quantity</th>
                                    <th class="text-end">Unit Price</th>
                                    <th class="text-end">Subtotal</th>
                                    <th class="text-end">Commission Rate</th>
                                    <th class="text-end">Commission</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in breakdown)
                                {
                                    <tr>
                                        <td>@item.OrderDate.ToString("yyyy-MM-dd")</td>
                                        <td>
                                            <small class="text-muted">@item.SubOrderNumber</small>
                                        </td>
                                        <td>
                                            <div>@item.ProductTitle</div>
                                            <small class="text-muted">SKU: @item.ProductSku</small>
                                        </td>
                                        <td class="text-end">@item.Quantity</td>
                                        <td class="text-end">@item.UnitPrice.ToString("C2")</td>
                                        <td class="text-end fw-bold">@item.Subtotal.ToString("C2")</td>
                                        <td class="text-end">@((item.CommissionRate * 100).ToString("0.00"))%</td>
                                        <td class="text-end text-danger">@item.CommissionAmount.ToString("C2")</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr class="fw-bold">
                                    <td colspan="7" class="text-end">Total Commission:</td>
                                    <td class="text-end text-danger">@breakdown.Sum(b => b.CommissionAmount).ToString("C2")</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        }
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> @errorMessage
        </div>
    }

    <!-- Invoices List -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Generated Invoices</h5>
        </div>
        <div class="card-body">
            @if (invoices == null || !invoices.Any())
            {
                <p class="text-muted">No invoices generated yet.</p>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Invoice Number</th>
                                <th>Period</th>
                                <th class="text-end">GMV</th>
                                <th class="text-end">Commission</th>
                                <th class="text-end">Net Amount</th>
                                <th>Generated</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var invoice in invoices)
                            {
                                <tr>
                                    <td>@invoice.InvoiceNumber</td>
                                    <td>
                                        <small>@invoice.PeriodStartDate.ToString("yyyy-MM-dd") to @invoice.PeriodEndDate.ToString("yyyy-MM-dd")</small>
                                    </td>
                                    <td class="text-end">@invoice.TotalGMV.ToString("C2")</td>
                                    <td class="text-end text-danger">@invoice.TotalCommission.ToString("C2")</td>
                                    <td class="text-end fw-bold text-success">@invoice.NetAmountDue.ToString("C2")</td>
                                    <td>
                                        <small>@invoice.GeneratedAt.ToString("yyyy-MM-dd HH:mm")</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-@GetStatusColor(invoice.Status)">@invoice.Status</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" @onclick="() => DownloadInvoice(invoice.Id)">
                                            <i class="bi bi-download"></i> Download
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private string periodType = "lastMonth";
    private DateTime startDate = DateTime.Today.AddMonths(-1);
    private DateTime endDate = DateTime.Today;
    private bool isLoading = false;
    private bool showBreakdown = false;
    private string? errorMessage = null;

    private SellerFinancialSummary? summary = null;
    private List<CommissionLineItem>? breakdown = null;
    private List<SellerInvoice>? invoices = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadInvoices();
        OnPeriodTypeChanged();
    }

    private void OnPeriodTypeChanged()
    {
        var today = DateTime.Today;
        switch (periodType)
        {
            case "thisMonth":
                startDate = new DateTime(today.Year, today.Month, 1);
                endDate = today;
                break;
            case "lastMonth":
                var lastMonth = today.AddMonths(-1);
                startDate = new DateTime(lastMonth.Year, lastMonth.Month, 1);
                endDate = startDate.AddMonths(1).AddDays(-1);
                break;
            case "last3Months":
                startDate = today.AddMonths(-3);
                endDate = today;
                break;
            case "last6Months":
                startDate = today.AddMonths(-6);
                endDate = today;
                break;
            case "thisYear":
                startDate = new DateTime(today.Year, 1, 1);
                endDate = today;
                break;
            // "custom" doesn't change the dates
        }
    }

    private async Task LoadReport()
    {
        isLoading = true;
        errorMessage = null;
        summary = null;
        breakdown = null;
        showBreakdown = false;

        try
        {
            summary = await ReportService.GetFinancialSummaryAsync(startDate, endDate);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load report: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ViewBreakdown()
    {
        if (!showBreakdown)
        {
            isLoading = true;
            try
            {
                breakdown = await ReportService.GetCommissionBreakdownAsync(startDate, endDate);
                showBreakdown = true;
            }
            catch (Exception ex)
            {
                errorMessage = $"Failed to load breakdown: {ex.Message}";
            }
            finally
            {
                isLoading = false;
            }
        }
        else
        {
            showBreakdown = false;
        }
    }

    private async Task GenerateInvoice()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var result = await ReportService.GenerateInvoiceAsync(startDate, endDate);
            if (result.Success)
            {
                await LoadInvoices();
                // Show success message or download invoice
                if (result.InvoiceId.HasValue)
                {
                    await DownloadInvoice(result.InvoiceId.Value);
                }
            }
            else
            {
                errorMessage = result.ErrorMessage ?? "Failed to generate invoice";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to generate invoice: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadInvoices()
    {
        try
        {
            invoices = await ReportService.GetInvoicesAsync();
        }
        catch (Exception ex)
        {
            // Log error but don't show to user since this is background load
            Console.WriteLine($"Failed to load invoices: {ex.Message}");
        }
    }

    private async Task DownloadInvoice(Guid invoiceId)
    {
        try
        {
            var html = await ReportService.DownloadInvoiceAsync(invoiceId);
            
            // Open in new tab
            await JSRuntime.InvokeVoidAsync("open", $"data:text/html;charset=utf-8,{Uri.EscapeDataString(html)}", "_blank");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to download invoice: {ex.Message}";
        }
    }

    private string GetStatusColor(string status)
    {
        return status switch
        {
            "Generated" => "success",
            "Sent" => "info",
            "Paid" => "primary",
            _ => "secondary"
        };
    }

    // Placeholder JSRuntime - should be injected
    [Inject]
    private IJSRuntime JSRuntime { get; set; } = null!;
}
